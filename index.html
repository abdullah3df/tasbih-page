<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>تسبيح — شارك الأجر</title>
<style>
  :root{
    --bg1:#0c1514;--bg2:#0f1c1a;--bg3:#112624;
    --card:#0f2321cc;--edge:#1a3c37;--ring:#173a35;
    --text:#eef8f6;--muted:#a8c9c2;
    --mint1:#9ff3e3;--mint2:#3fd6bf;--cta1:#38c77c;--cta2:#1aa35f;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  body{
    margin:0;min-height:100dvh;display:grid;place-items:center;color:var(--text);
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    background:
      radial-gradient(1200px 700px at 110% -10%, #1a5e54 0, #0000 60%),
      radial-gradient(1100px 800px at -10% 120%, #164a45 0, #0000 60%),
      linear-gradient(180deg,var(--bg1),var(--bg2) 50%, var(--bg3));
    overflow:hidden;
  }
  .wrap{ width:min(96vw,780px); padding:22px; display:none }
  .wrap.visible{ display:block }
  .card{
    background:var(--card); border:1px solid var(--edge); border-radius:28px; padding:26px;
    box-shadow:0 24px 64px #000a; text-align:center;
  }
  h1{margin:0 0 8px;font-weight:900;font-size:clamp(1.1rem,2.6vw,1.4rem)}
  .sub{margin:0 0 16px;color:var(--muted)}

  /* نص الذكر (صغير ومُتجاوب) + اهتزاز خفيف */
  #dhikrText{
    font-weight:900; margin:12px auto 8px; line-height:1.8; white-space:normal;
    font-size:0; opacity:0; transform:translateY(-8px) scale(.98);
    transition:opacity .3s, transform .3s, font-size .3s; min-height:3.8em;
  }
  #dhikrText.show{ opacity:1; transform:translateY(0) scale(1); font-size:clamp(.9rem,3vw,1.3rem) }
  #dhikrText.shake{ animation:shake .35s ease both }
  @keyframes shake{0%,100%{transform:translateX(0)}15%,45%,75%{transform:translateX(3px)}30%,60%,90%{transform:translateX(-3px)}}

  /* الدائرة = زر */
  .ringBtn{
    margin:8px auto 0; width:min(74vw,320px); height:min(74vw,320px); max-width:320px; max-height:320px;
    border-radius:50%; border:none; cursor:pointer; position:relative; display:block; isolation:isolate;
    background:conic-gradient(var(--mint2) 0deg, var(--mint1) var(--deg), var(--ring) var(--deg));
    box-shadow:16px 16px 34px rgba(0,0,0,.45), -10px -10px 26px rgba(255,255,255,.04),
               inset 0 0 0 10px #13302c, inset 0 0 0 1px #265d55;
  }
  .ringBtn::after{
    content:""; position:absolute; inset:8%; border-radius:50%;
    background:linear-gradient(180deg,#0d1e1c,#122826); border:1px solid #1e4e47; z-index:1;
    box-shadow: inset 12px 12px 20px rgba(0,0,0,.35), inset -10px -10px 18px rgba(255,255,255,.05);
  }
  .ring-label{ position:absolute; inset:0; display:grid; place-items:center; z-index:2; font-weight:900; color:#fff }

  .under{ margin-top:10px; color:var(--muted); font-weight:900 }
  .stats{ display:flex; gap:10px; justify-content:center; margin-top:12px; flex-wrap:wrap }
  .pill{ min-width:140px; padding:8px 12px; border-radius:999px; background:#0f2422; border:1px solid var(--edge) }

  /* صفحة النهاية */
  .only-card{ background:var(--card); border:1px solid var(--edge); border-radius:28px; padding:26px; text-align:center; box-shadow:0 24px 64px #000a }
  .visits{ color:var(--muted); margin:8px 0 12px }
  .bigShare{
    margin:10px auto; width:min(80vw,300px); height:min(80vw,300px); max-width:300px; max-height:300px;
    border:none; border-radius:50%; display:grid; place-items:center; color:#fff; font-weight:900; cursor:pointer;
    background:linear-gradient(145deg,var(--cta1),var(--cta2));
    box-shadow:12px 12px 22px rgba(10,59,39,.75), -12px -12px 22px rgba(31,214,128,.2),
               inset 10px 10px 18px rgba(0,0,0,.35), inset -10px -10px 18px rgba(255,255,255,.07);
  }
  .bigShare svg{ width:56px; height:56px; filter:drop-shadow(0 2px 4px rgba(0,0,0,.35)) }

  /* كانفاس المؤثرات */
  #celebrate{
    position:fixed; inset:0; pointer-events:none; display:none;
    z-index:9999; /* فوق كل شيء */
  }

  @media (prefers-reduced-motion: reduce){
    #dhikrText{ transition:none } #dhikrText.shake{ animation:none }
  }
</style>
</head>
<body>

<!-- صفحة التسبيح -->
<div id="app" class="wrap visible">
  <div class="card">
    <h1>تسبيح وذكر الله</h1>
    <p class="sub">اضغط الحلقة 10 مرات، ثم شارك الأجر مع أصدقائك</p>

    <div id="dhikrText">سبحان الله والحمد لله ولا إله إلا الله والله أكبر</div>

    <button id="ringBtn" class="ringBtn" style="--deg:0deg" aria-label="اضغط للتسبيح">
      <span class="ring-label">اضغط هنا</span>
    </button>
    <div class="under">المتبقي: <b id="left">10</b> / 10</div>

    <div class="stats">
      <div class="pill">العدّاد: <span id="count">0</span></div>
      <div class="pill">المشاركات: <span id="shares">0</span></div>
    </div>
  </div>
</div>

<!-- صفحة النهاية -->
<div id="end" class="wrap">
  <div class="only-card">
    <h2 style="margin:0 0 8px">جزاك الله خيرًا</h2>
    <div class="visits">زائروا الصفحة: <b id="visitors">—</b></div>
    <button id="shareOnly" class="bigShare" aria-label="مشاركة على واتساب">
      <svg viewBox="0 0 32 32" aria-hidden="true">
        <path fill="#E9FFF5" d="M16 3C9.37 3 4 8.37 4 15c0 2.11.53 4.11 1.46 5.86L4 29l8.33-1.3A12 12 0 0 0 28 15c0-6.63-5.37-12-12-12zm0 2c5.52 0 10 4.48 10 10a9.99 9.99 0 0 1-14.75 8.66l-.36-.2-4.52.7.9-4.41-.23-.39A9.97 9.97 0 0 1 6 15c0-5.52 4.48-10 10-10z"/>
        <path fill="#E9FFF5" d="M21.88 18.63c-.2-.1-1.2-.59-1.39-.66-.19-.07-.33-.1-.46.1-.13.2-.53.66-.65.79-.12.13-.24.15-.44.05-.2-.1-.84-.31-1.6-.99a5.83 5.83 0 0 1-1.08-1.33c-.12-.2 0-.31.09-.41.09-.09.2-.24.3-.36.1-.12.13-.2.2-.33.07-.13.03-.25-.01-.35-.04-.1-.46-1.11-.64-1.52-.17-.41-.34-.35-.46-.36h-.39c-.13 0-.35.05-.53.25-.18.2-.7.69-.7 1.68 0 1 .72 1.97.82 2.11.1.13 1.42 2.17 3.45 3.05.48.21.85.33 1.14.43.48.15.91.13 1.25.08.38-.06 1.2-.49 1.37-.96.17-.47.17-.88.12-.96-.05-.08-.18-.13-.38-.23z"/>
      </svg>
      <div>شارك الأجر على واتساب</div>
    </button>
  </div>
</div>

<!-- كانفاس المؤثرات -->
<canvas id="celebrate"></canvas>

<script>
(function(){
  const SHARE_URL = "https://share.google/y1S9s1xfewux5ikaA";
  const DHIKR = "سبحان الله والحمد لله ولا إله إلا الله والله أكبر";

  const app = document.getElementById('app');
  const endWrap = document.getElementById('end');
  const dhikrEl = document.getElementById('dhikrText');
  const ringBtn = document.getElementById('ringBtn');
  const leftEl = document.getElementById('left');
  const countEl = document.getElementById('count');
  const sharesEl = document.getElementById('shares');
  const visitorsEl = document.getElementById('visitors');
  const shareOnlyBtn = document.getElementById('shareOnly');
  const canvas = document.getElementById('celebrate');
  const ctx = canvas.getContext('2d');

  let target=10, left=10, count=0;
  let shares= +localStorage.getItem('tasbih_shares') || 0;
  sharesEl.textContent = shares;

  /* صوت بسيط */
  let audioCtx=null;
  function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
  function beep(f=760,d=90,v=0.07){ try{ ensureAudio(); const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.value=f; g.gain.value=v; o.connect(g).connect(audioCtx.destination); const t=audioCtx.currentTime; o.start(t); g.gain.exponentialRampToValueAtTime(0.0001,t+d/1000); o.stop(t+d/1000+0.02);}catch(_){} }
  window.addEventListener('pointerdown', ()=>{ try{ensureAudio();}catch(_){} }, {once:true});

  function setProgress(){ ringBtn.style.setProperty('--deg', ((target-left)/target)*360 + 'deg'); }
  function showDhikr(){
    dhikrEl.textContent = DHIKR;
    dhikrEl.classList.remove('show','shake'); void dhikrEl.offsetWidth;
    dhikrEl.classList.add('show','shake');
  }
  function updateUI(){
    leftEl.textContent = left; countEl.textContent = count; setProgress();
    if(left===0) showEnd();
  }

  ringBtn.addEventListener('click', ()=>{
    if(left<=0) return;
    count++; left--;
    if(navigator.vibrate) navigator.vibrate(16);
    beep(720+Math.random()*60,70,0.08);
    showDhikr();
    updateUI();
  });

  shareOnlyBtn.addEventListener('click', ()=>{
    window.open("https://wa.me/?text=" + encodeURIComponent(SHARE_URL), "_blank", "noopener");
    shares++; localStorage.setItem('tasbih_shares', shares); sharesEl.textContent = shares;
  });

  /* ===== مؤثرات الفرح/الحفل ===== */
  let particles=[], fireworks=[], rafId=null, startTime=0, duration=5000; // 5 ثوانٍ
  const colors = ["#fff176","#ffd54f","#ff8a65","#4dd0e1","#aed581","#ba68c8","#f06292","#fff"];

  function resizeCanvas(){
    canvas.width = innerWidth; canvas.height = innerHeight;
  }
  addEventListener('resize', resizeCanvas);

  function spawnConfetti(count=180){
    for(let i=0;i<count;i++){
      particles.push({
        x: Math.random()*canvas.width,
        y: -20 - Math.random()*canvas.height*0.4,
        r: 2 + Math.random()*4,
        c: colors[(Math.random()*colors.length)|0],
        vx: (-1+Math.random()*2)*2,
        vy: 2 + Math.random()*3,
        rot: Math.random()*Math.PI*2,
        vr: (-1+Math.random()*2)*0.1,
        life: 100+Math.random()*100
      });
    }
  }

  function spawnFirework(){
    const cx = canvas.width*(0.2+Math.random()*0.6);
    const cy = canvas.height*(0.3+Math.random()*0.5);
    const n = 40 + (Math.random()*20)|0;
    for(let i=0;i<n;i++){
      const a = (i/n)*Math.PI*2;
      const sp = 2 + Math.random()*3;
      fireworks.push({
        x: cx, y: cy,
        vx: Math.cos(a)*sp, vy: Math.sin(a)*sp,
        r: 2 + Math.random()*2,
        c: colors[(Math.random()*colors.length)|0],
        life: 60 + Math.random()*40
      });
    }
  }

  function drawParticles(list, gravity=0.05, drag=0.99){
    for(let i=list.length-1;i>=0;i--){
      const p = list[i];
      p.vy += gravity;
      p.vx *= drag; p.vy *= drag;
      p.x += p.vx; p.y += p.vy;
      p.rot = (p.rot||0) + (p.vr||0);
      p.life -= 1;
      // رسم
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot||0);
      ctx.fillStyle=p.c;
      ctx.globalAlpha = Math.max(0, Math.min(1, p.life/100));
      ctx.fillRect(-p.r, -p.r, p.r*2, p.r*2);
      ctx.restore();
      if(p.life<=0 || p.y>canvas.height+20) list.splice(i,1);
    }
  }

  function loop(ts){
    if(!startTime) startTime = ts;
    const elapsed = ts - startTime;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawParticles(particles, 0.06, 0.992);
    drawParticles(fireworks, 0.02, 0.985);

    // نضيف دفعات خلال أول 2.5 ثانية
    if(elapsed < duration*0.5){
      if(elapsed % 200 < 16) spawnFirework();
      if(elapsed % 180 < 16) spawnConfetti(60);
    }

    if(elapsed < duration || particles.length || fireworks.length){
      rafId = requestAnimationFrame(loop);
    }else{
      // نهاية العرض
      canvas.style.display = 'none';
      cancelAnimationFrame(rafId);
      rafId=null; startTime=0;
    }
  }

  function startCelebrate(){
    if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
    resizeCanvas();
    canvas.style.display = 'block';
    particles.length=0; fireworks.length=0; startTime=0;
    spawnConfetti(200);
    spawnFirework(); spawnFirework();
    rafId = requestAnimationFrame(loop);
  }

  /* ===== صفحة النهاية + عداد زوار ===== */
  async function showEnd(){
    app.classList.remove('visible'); app.style.display='none';
    endWrap.classList.add('visible');

    // ابدأ مؤثرات الفرح
    startCelebrate();

    // عدّاد زوّار (ثابت + بديل محلي)
    const NS="tasbih-app", KEY="main-page-visitors";
    try{
      const r=await fetch(`https://api.countapi.xyz/hit/${NS}/${KEY}`, {cache:"no-store"});
      const d=await r.json();
      if(typeof d.value==="number"){ visitorsEl.textContent = d.value.toLocaleString('ar-EG'); return; }
      throw 0;
    }catch(e){
      try{
        const k="local_visitors_once"; let v=+localStorage.getItem(k)||0;
        if(!localStorage.getItem('visited_once_flag')){ v++; localStorage.setItem(k,v); localStorage.setItem('visited_once_flag','1'); }
        visitorsEl.textContent = "≈ " + v.toLocaleString('ar-EG');
      }catch{ visitorsEl.textContent = "—"; }
    }
  }

  setProgress(); // تهيئة
})();
</script>
</body>
</html>
